
# 协议
上位机：电脑端控制软件；  
下位机：机载飞控；  
下行的协议分为五个模式：开始模式（等待模式），手动控制模式，实际应用模式，调参实验模式，故障模式;  
五种不同的模式，所下发的指令不一样；具体根据飞行器收到的报文ID作判断；  
## 开始模式(0x00)：  
完成所有执行器和状态量的初始化；
## 手动控制模式(0x08)：  
上位机能直接控制各电机，各舵机，此时遥控的指令失效；机载下位机实时发送姿态状态值、电机控制量值、PID参数值；  
## 实际应用模式(0x10)：  
此状态下，上位机不再直接控制各执行器，而是控制飞行器的飞行运动（前后、升降、左右、偏航）和PID的参数值；下位机自身在PID算法的作用下保持稳定; 下位机实时上传姿态信息，电机驱动电机；
## 调参实验模式(0x18):  
此状态下，要能实现在线PID调参；上位机发送当前所设定的姿态角度信息，设定的PID的参数信息，下位机实时回传当前实际的姿态角度，PID误差信息，电机舵机控制信息；  
## 故障模式(0x38)： 
完成当前NRF24L01的状态检测，如果检测NRF24L01离线或者通讯失败,则一直处于这个模式中，直到通讯成功，跳转到开始模式；

系统状态结构变量SYS_Status，其中DTU_NRF_Status 表示当前遥控接收机，NRF无线传输模块是否存在，并且通讯是否正常；
DTU_NRF_Status 是一个u8变量，其中每一位代表的含义：
| 位数 | 7 | 6 | 5 |4| 3 | 2 | 1 | 0 |
|---|---|---|---|---|---|---|---|---|
||暂留|暂留|MODE_ID3|MODE_ID2|MODE_ID1| DTU是否能正常通讯 | NRF是否通讯正常 | NRF是否在线 |

## 握手码：  
###下行  
| 字节数 | 1 | 0 |
|---|---|---|
|  |模式|0x18|
###上行  
| 字节数 |28|27|26|25|24|23|22|21|20|19|18|17|16|15|14|13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|  |系统时间_H2|系统时间_H1|系统时间_L2|系统时间_L1|当前横滚角_H|当前横滚角_L|当前俯仰角_H|当前俯仰角_L|当前偏航角_H|当前偏航角_L|Roll_Kd_Ext|Roll_Ki_Ext|Roll_Kp_Ext|Roll_Kd_Int|Roll_Ki_Int|Roll_Kp_Int|
| |12|11| 10 | 9 | 8 | 7 | 6 | 5 |4| 3 | 2 | 1 | 0 |
|  |Pitch_Kd_Ext|Pitch_Ki_Ext|Pitch_Kp_Ext|Pitch_Kd_Int|Pitch_Ki_Int|Pitch_Kp_Int|Yaw_Kd_Ext|Yaw_Ki_Ext|Yaw_Kp_Ext|Yaw_Kd_Int|Yaw_Ki_Int|Kp_Int|0xAA|

## 下行

### 手动控制模式

报文ID: 0x18
|控制量 | 数据类型|
|---|---|
|拍打电机转速|uint8_t|
|爬行电机转速|uint8_t|
|俯仰舵机| uint8_t|
|横滚舵机| uint8_t|
|偏航舵机| uint8_t|

### 实际应用模式
报文ID: 0x08
控制量 | 数据类型
---|---
前后|uint8_t
左右|uint8_t
升降|uint8_t
偏航|uint8_t

### 调参实验模式
报文ID: 0x10

控制量 | 数据类型
---|---
PID_ID|uint8_t
Kp_Int|uint8_t
Ki_Int|uint8_t
Kd_Int|uint8_t
Kp_Ext|uint8_t
Ki_Ext|uint8_t
Kd_Ext|uint8_t
SetValue|uint16_t


PID_ID指定当前整定的是哪一个姿态角的PID,PID_ID可以为0x00,0x01,0x02;分别对应Yaw,Pitch,Roll;




## 上行
### 基础控制类型
报文ID: 0xB0
控制量 | 数据类型
---|---
拍打电机转速|uint8_t
爬行电机转速|uint8_t
俯仰舵机|uint8_t
横滚舵机|uint8_t
偏航舵机|uint8_t
偏航角速度|uint16_t
俯仰角速度|uint16_t
横滚角速度|uint16_t
偏航角|uint16_t
俯仰角|uint16_t
横滚角|uint16_t
系统时间|uint32_t




